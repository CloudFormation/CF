{
    "Resources": {
        "CodeBuildProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "ServiceRole": {
                    "Ref": "CodeBuildRole"
                },
                "Artifacts": {
                    "Type": "NO_ARTIFACTS"
                },
                "BadgeEnabled": "true",
                "Environment": {
                    "Type": "LINUX_CONTAINER",
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "maven:3.5.0-jdk-8",
                    "EnvironmentVariables": [
                        {
                            "Name": "varName1",
                            "Value": "varValue1"
                        },
                        {
                            "Name": "varName2",
                            "Value": "varValue2",
                            "Type": "PLAINTEXT"
                        },
                        {
                            "Name": "varName3",
                            "Value": "/CodeBuild/testParameter",
                            "Type": "PARAMETER_STORE"
                        }
                    ]
                },
                "Source": {
                    "Location": "https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/test",
                    "Type": "CODECOMMIT",
                    "BuildSpec": "version: 0.2\nphases:\n  install:\n    commands:\n      - apt-get update -y\n      - apt-get install -y awscli\n  pre_build:\n    commands:\n      - echo maven version is `mvn -version`\n  build:\n    commands:\n      - echo Build started on `date`\n      - mvn compile war:war\n  post_build:\n    commands:\n      - echo Build completed on `date`\n      - echo $(basename mvc-*.war) | grep -o \"[0-9].[0-9].[0-9].[A-Z]*\" | tr -d '\\n' > build.txt\n      - aws s3 cp target/mvc-*.war s3://bucket-name/java/\nartifacts:\n  files:\n      - build.txt\n  discard-paths: yes\n"
                }
            }
        },
        "CodeBuildRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codebuild.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "CodeBuildAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Action": [
                                        "logs:*",
                                        "ec2:CreateNetworkInterface",
                                        "ec2:DescribeNetworkInterfaces",
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeSecurityGroups",
                                        "ec2:DescribeDhcpOptions",
                                        "ec2:DescribeVpcs",
                                        "ec2:CreateNetworkInterfacePermission"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        }
    }
}
